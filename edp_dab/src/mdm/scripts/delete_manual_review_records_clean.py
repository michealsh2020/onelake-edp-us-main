# Databricks notebook source
dbutils.widgets.text("source_catalog", "", "Catalog")
source_catalog = dbutils.widgets.get("source_catalog")

# COMMAND ----------

# Move the manual review records from sf_account_clean_address table to history table(sf_account_clean_address_reviewed)
# Delete manual review records present in sf_account_clean_address table
# The total count must match with delete count

%sql
select count(*) from ${source_catalog}.clean.sf_account_clean_address where sid_id in (select distinct sid_id from ${source_catalog}.tmp.sf_account_clean_address_for_review where needs_manual_review = true) and needs_manual_review=true

insert into ${source_catalog}.clean.sf_account_clean_address_reviewed(sid_id,name,name_clean,name_clean_acct_flag,name_clean_on_behalf_flag,name_clean_aka_flag,name_clean_asterisks_flag,name_clean_care_of_flag,name_clean_dba_flag,name_clean_donot_flag,name_clean_duplicate_flag,name_clean_fbo_flag,name_clean_length_flag,name_clean_none_na_flag,name_clean_student_flag,name_clean_test_flag,name_clean_trust_flag,name_clean_tbd_flag,review_name_clean_flag,billing_street,billing_street_clean,billing_street_clean_attn_flag,billing_street_clean_asterisks_flag,billing_street_clean_care_of_flag,billing_street_clean_tbd_flag,billing_street_clean_test_flag,review_billing_street_clean_flag,shipping_street,shipping_street_clean,shipping_street_clean_attn_flag,shipping_street_clean_asterisks_flag,shipping_street_clean_care_of_flag,
shipping_street_clean_tbd_flag,shipping_street_clean_test_flag,review_shipping_street_clean_flag,billing_city,billing_city_clean,billing_city_clean_null_flag,billing_city_clean_number_flag,shipping_city,shipping_city_clean,shipping_city_clean_null_flag,shipping_city_clean_number_flag,billing_state,billing_state_clean,billing_country,billing_country_clean,billing_postal_code,billing_postal_code_clean,billing_state_clean_null_flag,billing_state_clean_number_flag,invalid_ca_billing_state_flag,invalid_au_billing_state_flag,invalid_us_billing_state_flag,review_billing_state_clean_flag,billing_country_clean_null_flag,billing_country_clean_number_flag,shipping_state,shipping_state_clean,shipping_country,shipping_country_clean,shipping_postal_code,shipping_postal_code_clean,shipping_state_clean_null_flag,shipping_state_clean_number_flag,invalid_ca_shipping_state_flag,invalid_au_shipping_state_flag,invalid_us_shipping_state_flag,review_shipping_state_clean_flag,shipping_country_clean_null_flag,shipping_country_clean_number_flag,review_invalid_billing_postal_code_clean_flag,review_invalid_shipping_postal_code_clean_flag,final_review_postal_code_flag,final_review_all_address_columns_flag,system_modstamp,account_id,named_account,billing_geolocation,shipping_geolocation,billing_address_complete,billing_address_validation_status_msg,shipping_address_complete,shipping_address_validation_status_msg,master_record_id,type,billing_latitude,billing_longitude,billing_geocode_accuracy,shipping_latitude,shipping_longitude,shipping_geocode_accuracy,phone,account_number,website,created_date,created_by_id,last_modified_date,last_modified_by_id,archived,billing_county,shipping_county,billing_address_validation_status,hash_key,ingested_timestamp,final_clean_flag,address_last_cleaned_timestamp,name_clean_additional_data,billing_street_clean_additional_data,shipping_street_clean_additional_data,review_billing_address_flag,review_shipping_address_flag,needs_manual_review)

select sid_id,name,name_clean,name_clean_acct_flag,name_clean_on_behalf_flag,name_clean_aka_flag,name_clean_asterisks_flag,name_clean_care_of_flag,name_clean_dba_flag,name_clean_donot_flag,name_clean_duplicate_flag,name_clean_fbo_flag,name_clean_length_flag,name_clean_none_na_flag,name_clean_student_flag,name_clean_test_flag,name_clean_trust_flag,name_clean_tbd_flag,review_name_clean_flag,billing_street,billing_street_clean,billing_street_clean_attn_flag,billing_street_clean_asterisks_flag,billing_street_clean_care_of_flag,billing_street_clean_tbd_flag,billing_street_clean_test_flag,review_billing_street_clean_flag,shipping_street,shipping_street_clean,shipping_street_clean_attn_flag,shipping_street_clean_asterisks_flag,shipping_street_clean_care_of_flag,
shipping_street_clean_tbd_flag,shipping_street_clean_test_flag,review_shipping_street_clean_flag,billing_city,billing_city_clean,billing_city_clean_null_flag,billing_city_clean_number_flag,shipping_city,shipping_city_clean,shipping_city_clean_null_flag,shipping_city_clean_number_flag,billing_state,billing_state_clean,billing_country,billing_country_clean,billing_postal_code,billing_postal_code_clean,billing_state_clean_null_flag,billing_state_clean_number_flag,invalid_ca_billing_state_flag,invalid_au_billing_state_flag,invalid_us_billing_state_flag,review_billing_state_clean_flag,billing_country_clean_null_flag,billing_country_clean_number_flag,shipping_state,shipping_state_clean,shipping_country,shipping_country_clean,shipping_postal_code,shipping_postal_code_clean,shipping_state_clean_null_flag,shipping_state_clean_number_flag,invalid_ca_shipping_state_flag,invalid_au_shipping_state_flag,invalid_us_shipping_state_flag,review_shipping_state_clean_flag,shipping_country_clean_null_flag,shipping_country_clean_number_flag,review_invalid_billing_postal_code_clean_flag,review_invalid_shipping_postal_code_clean_flag,final_review_postal_code_flag,final_review_all_address_columns_flag,system_modstamp,account_id,named_account,billing_geolocation,shipping_geolocation,billing_address_complete,billing_address_validation_status_msg,shipping_address_complete,shipping_address_validation_status_msg,master_record_id,type,billing_latitude,billing_longitude,billing_geocode_accuracy,shipping_latitude,shipping_longitude,shipping_geocode_accuracy,phone,account_number,website,created_date,created_by_id,last_modified_date,last_modified_by_id,archived,billing_county,shipping_county,billing_address_validation_status,hash_key,ingested_timestamp,final_clean_flag,address_last_cleaned_timestamp,name_clean_additional_data,billing_street_clean_additional_data,shipping_street_clean_additional_data,review_billing_address_flag,review_shipping_address_flag,needs_manual_review 
from ${source_catalog}.clean.sf_account_clean_address where sid_id in (select distinct sid_id from ${source_catalog}.tmp.sf_account_clean_address_for_review where needs_manual_review =true) and needs_manual_review=true

delete from ${source_catalog}.clean.sf_account_clean_address where sid_id in (select distinct sid_id from ${source_catalog}.tmp.sf_account_clean_address_for_review where needs_manual_review = true)
